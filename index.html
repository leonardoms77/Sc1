<!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulador de Book PETR4</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f7f7f7; }
    h1 { text-align: center; }
    .container { display: flex; justify-content: space-between; gap: 1rem; }
    .book { width: 48%; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 300px; overflow-y: scroll; }
    .order { display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #eee; }
    .controls, .portfolios { margin-top: 1rem; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    textarea { width: 100%; height: 80px; margin-top: 0.5rem; }
    button { margin-top: 0.5rem; padding: 0.5rem 1rem; }
    .portfolios div { margin-bottom: 0.25rem; }
  </style>
</head>
<body>
  <h1>Simulador de Book PETR4</h1>
  <div class="container">
    <div class="book" id="buyBook">
      <h3>Ordem de Compra</h3>
    </div>
    <div class="book" id="sellBook">
      <h3>Ordem de Venda</h3>
    </div>
  </div>  <div class="controls">
    <h3>Inserir Ordem Manual</h3>
    <textarea id="manualOrder" placeholder="UBS BUY 1000 @ 36.50"></textarea>
    <button onclick="submitOrder()">Enviar Ordem</button><h3>Script do Robô (1 ordem por rodada)</h3>
<textarea id="botScript" placeholder="XP SELL 500 @ 37.20\nCS BUY 300 @ 36.90"></textarea>
<button onclick="nextRound()">Executar Rodada</button>
<button onclick="togglePause()">Pausar / Continuar</button>
<button onclick="saveState()">Salvar</button>
<button onclick="loadState()">Carregar</button>

  </div>  <div class="portfolios">
    <h3>Portfólios</h3>
    <div id="portfolios"></div>
  </div>  <script>
    const players = ["UBS", "CS", "MS", "Merrill", "XP"];
    let portfolio = {};
    let buyBook = [];
    let sellBook = [];
    let paused = false;

    players.forEach(p => portfolio[p] = { cash: 700000000, shares: 0 });

    function renderBooks() {
      const buyEl = document.getElementById("buyBook");
      const sellEl = document.getElementById("sellBook");
      buyEl.innerHTML = '<h3>Ordem de Compra</h3>';
      sellEl.innerHTML = '<h3>Ordem de Venda</h3>';

      buyBook.sort((a,b) => b.price - a.price);
      sellBook.sort((a,b) => a.price - b.price);

      buyBook.slice(0,20).forEach(o => {
        buyEl.innerHTML += `<div class='order'><span>${o.player}</span><span>${o.qty} @ ${o.price.toFixed(2)}</span></div>`;
      });

      sellBook.slice(0,20).forEach(o => {
        sellEl.innerHTML += `<div class='order'><span>${o.player}</span><span>${o.qty} @ ${o.price.toFixed(2)}</span></div>`;
      });
    }

    function renderPortfolios() {
      const port = document.getElementById("portfolios");
      port.innerHTML = '';
      players.forEach(p => {
        const cash = (portfolio[p].cash / 1000000).toFixed(2);
        const shares = portfolio[p].shares;
        port.innerHTML += `<div><strong>${p}</strong> - R$ ${cash} mi | ${shares} ações</div>`;
      });
    }

    function parseOrder(line) {
      const match = line.trim().match(/(\w+)\s+(BUY|SELL)\s+(\d+)\s+@\s+(\d+(\.\d+)?)/i);
      if (!match) return null;
      return {
        player: match[1].toUpperCase(),
        side: match[2].toUpperCase(),
        qty: parseInt(match[3]),
        price: parseFloat(match[4])
      };
    }

    function submitOrder() {
      const text = document.getElementById("manualOrder").value;
      const order = parseOrder(text);
      if (!order) return alert("Ordem inválida");
      processOrder(order);
      renderBooks();
      renderPortfolios();
    }

    function processOrder(order) {
      const book = order.side === "BUY" ? buyBook : sellBook;
      book.push(order);
      matchOrders();
    }

    function nextRound() {
      if (paused) return;
      const lines = document.getElementById("botScript").value.split("\n").filter(l => l.trim());
      if (lines.length === 0) return;
      const order = parseOrder(lines.shift());
      if (order) processOrder(order);
      document.getElementById("botScript").value = lines.join("\n");
      renderBooks();
      renderPortfolios();
    }

    function togglePause() {
      paused = !paused;
      alert(paused ? "Pausado" : "Continuando");
    }

    function matchOrders() {
      buyBook.sort((a,b) => b.price - a.price);
      sellBook.sort((a,b) => a.price - b.price);

      while (buyBook.length && sellBook.length && buyBook[0].price >= sellBook[0].price) {
        const buy = buyBook[0];
        const sell = sellBook[0];
        const qty = Math.min(buy.qty, sell.qty);
        const price = sell.price;

        buy.qty -= qty;
        sell.qty -= qty;

        portfolio[buy.player].cash -= qty * price;
        portfolio[buy.player].shares += qty;

        portfolio[sell.player].cash += qty * price;
        portfolio[sell.player].shares -= qty;

        if (buy.qty === 0) buyBook.shift();
        if (sell.qty === 0) sellBook.shift();
      }
    }

    function saveState() {
      const state = JSON.stringify({ buyBook, sellBook, portfolio });
      localStorage.setItem("bookState", state);
      alert("Estado salvo!");
    }

    function loadState() {
      const state = JSON.parse(localStorage.getItem("bookState"));
      if (!state) return alert("Nada salvo!");
      buyBook = state.buyBook || [];
      sellBook = state.sellBook || [];
      portfolio = state.portfolio || {};
      renderBooks();
      renderPortfolios();
    }

    renderBooks();
    renderPortfolios();
  </script></body>
</html>
